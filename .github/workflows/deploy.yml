name: Deploy to Azure AKS

on:
  push:
    branches: [ main ]

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout code
      uses: actions/checkout@v3
      
    - name: Setup Node.js
      uses: actions/setup-node@v3
      with:
        node-version: '14'
        
    - name: Install dependencies
      run: npm install
      
    - name: Run tests
      run: npm test
      
    - name: Verify required files
      run: |
        test -f verification.txt && echo "‚úÖ verification.txt exists"
        npm run | grep test && echo "‚úÖ test script exists"
      
    - name: Login to Azure
      uses: azure/login@v1
      with:
        creds: ${{ secrets.AZURE_CREDENTIALS }}
        
    - name: Set AKS context
      run: |
        az aks get-credentials --resource-group seu-resource-group --name seu-cluster-aks --overwrite-existing
        
    - name: Build and push to ACR
      run: |
        az acr build --image restaurante-frances:latest --registry restauranteregistry .
        
    - name: Deploy to AKS
      run: |
        # Atualizar a imagem do deployment
        kubectl set image deployment/restaurante-frances restaurante-frances=restauranteregistry.azurecr.io/restaurante-frances:latest
        
        # Aguardar o rollout
        kubectl rollout status deployment/restaurante-frances --timeout=180s
        
    - name: Verify deployment
      run: |
        # Verificar o IP do LoadBalancer (usando o nome CORRETO do servi√ßo)
        IP=$(kubectl get service restaurante-lb -o jsonpath='{.status.loadBalancer.ingress[0].ip}')
        echo "üéâ IP do LoadBalancer: $IP"
        echo "üìù URL da aplica√ß√£o: http://$IP"
        
        # Testar a sa√∫de da aplica√ß√£o
        curl -f http://$IP/health || echo "A aplica√ß√£o est√° iniciando..."
