name: CI/CD → ACR → AKS (fallback to App Service)

on:
  push:
    branches:
      - main

env:
  IMAGE_NAME: restaurantefrances

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      id-token: write
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Login to Azure (Service Principal JSON)
        uses: azure/login@v2
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}
      # If you prefer OIDC, replace the above step with OIDC usage described in the docs.

      - name: Set up variables
        id: vars
        run: |
          echo "ACR_NAME=${{ secrets.ACR_NAME }}" >> $GITHUB_ENV
          echo "RESOURCE_GROUP=${{ secrets.AZ_RESOURCE_GROUP }}" >> $GITHUB_ENV
          echo "AKS_NAME=${{ secrets.AKS_NAME }}" >> $GITHUB_ENV
          echo "WEBAPP_NAME=${{ secrets.WEBAPP_NAME }}" >> $GITHUB_ENV
          echo "LOCATION=${{ secrets.AZ_LOCATION }}" >> $GITHUB_ENV
          echo "IMAGE_TAG=${GITHUB_SHA::8}" >> $GITHUB_ENV

      - name: Build & push image to ACR (az acr build)
        id: acr_build
        run: |
          echo "Building image in ACR..."
          az acr build --registry $ACR_NAME --image $IMAGE_NAME:${IMAGE_TAG} .

      - name: Get ACR loginServer
        id: acrinfo
        run: |
          LOGIN_SERVER=$(az acr show --name $ACR_NAME --resource-group $RESOURCE_GROUP --query "loginServer" -o tsv)
          echo "ACR_LOGIN_SERVER=$LOGIN_SERVER" >> $GITHUB_ENV
          echo "ACR_LOGIN_SERVER=$LOGIN_SERVER"

      - name: Try deploy to AKS (update image)
        id: aks_deploy
        run: |
          set +e
          echo "Getting AKS credentials..."
          az aks get-credentials --resource-group $RESOURCE_GROUP --name $AKS_NAME --overwrite-existing || echo "ERROR_GET_CREDS=$?"
          echo "Attempting kubectl set image..."
          kubectl set image deployment/restaurante-deployment restaurante=${ACR_LOGIN_SERVER}/${IMAGE_NAME}:${IMAGE_TAG} --record
          RC=$?
          if [ $RC -eq 0 ]; then
            echo "aks_status=success" >> $GITHUB_OUTPUT
          else
            echo "aks_status=failure" >> $GITHUB_OUTPUT
          fi
          exit 0

      - name: Check AKS deploy result
        run: |
          echo "AKS deploy status: ${{ steps.aks_deploy.outputs.aks_status }}"

      - name: Fallback → Deploy to Azure Web App for Containers (if AKS failed)
        if: ${{ steps.aks_deploy.outputs.aks_status == 'failure' }}
        id: fallback
        run: |
          set -e
          # create plan if not exists
          az appservice plan create --name "plan-${WEBAPP_NAME}" --resource-group $RESOURCE_GROUP --sku B1 --is-linux || echo "plan exists or created"
          # create or update webapp to point to container image in ACR
          az webapp create \
            --resource-group $RESOURCE_GROUP \
            --plan "plan-${WEBAPP_NAME}" \
            --name $WEBAPP_NAME \
            --deployment-container-image-name ${ACR_LOGIN_SERVER}/${IMAGE_NAME}:${IMAGE_TAG} || echo "webapp may already exist"
          # ensure webapp can pull from ACR (assign system identity and role if necessary)
          echo "Configuring ACR pull permissions (if required)..."
          WEBAPP_PRINCIPAL_ID=$(az webapp identity assign --name $WEBAPP_NAME --resource-group $RESOURCE_GROUP --query principalId -o tsv)
          ACR_ID=$(az acr show --name $ACR_NAME --resource-group $RESOURCE_GROUP --query id -o tsv)
          az role assignment create --assignee $WEBAPP_PRINCIPAL_ID --role "AcrPull" --scope $ACR_ID || echo "role assignment may already exist"
          # show final url
          echo "Application URL:"
          az webapp show --name $WEBAPP_NAME --resource-group $RESOURCE_GROUP --query defaultHostName -o tsv

      - name: Output final status
        run: |
          if [ "${{ steps.aks_deploy.outputs.aks_status }}" = "success" ]; then
            echo "Deployment completed on AKS. Service should be available through your LoadBalancer/Ingress."
          else
            echo "AKS deploy failed → fallback deployed (or updated) on Azure Web App for Containers."
          fi
